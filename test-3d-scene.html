<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 3D Scene Initialization</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #configurator-scene {
            width: 800px;
            height: 600px;
            border: 2px solid #ccc;
            background: #f5f5f5;
        }
        .test-info {
            margin-bottom: 20px;
            padding: 10px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h2>3D Scene Initialization Test</h2>
        <p>This test verifies that the Three.js scene, camera, renderer, lighting, and render loop are properly initialized.</p>
        <p><strong>Requirements tested:</strong> 2.1, 2.2, 2.4</p>
        <div id="test-results"></div>
    </div>
    
    <div id="configurator-scene"></div>
    
    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Load Three.js -->
    <script src="assets/js/three.min.js"></script>
    
    <!-- Load OrbitControls -->
    <script src="assets/js/OrbitControls.js"></script>
    
    <!-- Load GLTFLoader -->
    <script src="assets/js/GLTFLoader.js"></script>
    
    <!-- Mock WordPress localization -->
    <script>
        var blastiConfigurator = {
            ajaxUrl: '/wp-admin/admin-ajax.php',
            nonce: 'test-nonce',
            pluginUrl: './',
            modelsUrl: './assets/models/',
            settings: {
                mobileOptimization: true,
                cacheModels: true,
                maxAccessories: 50,
                themeIntegration: true
            },
            strings: {
                loading: 'Loading...',
                error: 'An error occurred. Please try again.',
                selectPegboard: 'Please select a pegboard first.',
                addToCart: 'Add to Cart',
                addToCartSuccess: 'Items added to cart successfully!',
                addToCartError: 'Failed to add items to cart. Please try again.',
                maxAccessoriesReached: 'Maximum number of accessories reached.',
                invalidPlacement: 'Cannot place accessory at this position.',
                loadingModel: 'Loading 3D model...',
                subtotal: 'Subtotal',
                priceError: 'Price Error',
                noPegboardSelected: 'No pegboard selected',
                noAccessoriesPlaced: 'No accessories placed'
            }
        };
    </script>
    
    <!-- Load configurator -->
    <script src="assets/js/configurator.js"></script>
    
    <!-- Test script -->
    <script>
        jQuery(document).ready(function($) {
            var results = [];
            
            // Wait a moment for initialization
            setTimeout(function() {
                // Test 1: Check if scene was created
                if (BlastiConfigurator.config.scene instanceof THREE.Scene) {
                    results.push('<p class="success">✓ Scene created successfully</p>');
                } else {
                    results.push('<p class="error">✗ Scene not created</p>');
                }
                
                // Test 2: Check if camera was created
                if (BlastiConfigurator.config.camera instanceof THREE.PerspectiveCamera) {
                    results.push('<p class="success">✓ Camera created successfully</p>');
                    results.push('<p>  - Position: (' + 
                        BlastiConfigurator.config.camera.position.x + ', ' +
                        BlastiConfigurator.config.camera.position.y + ', ' +
                        BlastiConfigurator.config.camera.position.z + ')</p>');
                } else {
                    results.push('<p class="error">✗ Camera not created</p>');
                }
                
                // Test 3: Check if renderer was created
                if (BlastiConfigurator.config.renderer instanceof THREE.WebGLRenderer) {
                    results.push('<p class="success">✓ Renderer created successfully</p>');
                    results.push('<p>  - Shadow map enabled: ' + 
                        BlastiConfigurator.config.renderer.shadowMap.enabled + '</p>');
                } else {
                    results.push('<p class="error">✗ Renderer not created</p>');
                }
                
                // Test 4: Check if controls were created
                if (BlastiConfigurator.config.controls) {
                    results.push('<p class="success">✓ OrbitControls created successfully</p>');
                    results.push('<p>  - Damping enabled: ' + 
                        BlastiConfigurator.config.controls.enableDamping + '</p>');
                } else {
                    results.push('<p class="error">✗ OrbitControls not created</p>');
                }
                
                // Test 5: Check if lighting was added
                var lights = BlastiConfigurator.config.scene.children.filter(function(child) {
                    return child instanceof THREE.Light;
                });
                if (lights.length >= 2) {
                    results.push('<p class="success">✓ Lighting setup complete (' + lights.length + ' lights)</p>');
                } else {
                    results.push('<p class="error">✗ Insufficient lighting</p>');
                }
                
                // Test 6: Check if ground plane was added
                var meshes = BlastiConfigurator.config.scene.children.filter(function(child) {
                    return child instanceof THREE.Mesh;
                });
                if (meshes.length > 0) {
                    results.push('<p class="success">✓ Ground plane added</p>');
                } else {
                    results.push('<p class="error">✗ Ground plane not found</p>');
                }
                
                // Test 7: Check if canvas was added to DOM
                var canvas = document.querySelector('#configurator-scene canvas');
                if (canvas) {
                    results.push('<p class="success">✓ Canvas added to DOM</p>');
                    results.push('<p>  - Canvas size: ' + canvas.width + 'x' + canvas.height + '</p>');
                } else {
                    results.push('<p class="error">✗ Canvas not found in DOM</p>');
                }
                
                // Test 8: Check if resize handler is working
                var originalWidth = BlastiConfigurator.config.renderer.domElement.width;
                window.dispatchEvent(new Event('resize'));
                setTimeout(function() {
                    results.push('<p class="success">✓ Resize handler registered</p>');
                    
                    // Display all results
                    $('#test-results').html(results.join(''));
                    
                    // Add a test cube to verify rendering
                    var geometry = new THREE.BoxGeometry(1, 1, 1);
                    var material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
                    var cube = new THREE.Mesh(geometry, material);
                    cube.position.set(0, 0.5, 0);
                    cube.castShadow = true;
                    cube.receiveShadow = true;
                    BlastiConfigurator.config.scene.add(cube);
                    
                    // Animate the cube
                    function animateCube() {
                        requestAnimationFrame(animateCube);
                        cube.rotation.x += 0.01;
                        cube.rotation.y += 0.01;
                    }
                    animateCube();
                    
                    results.push('<p class="success">✓ Test cube added and animating</p>');
                    $('#test-results').html(results.join(''));
                }, 100);
            }, 500);
        });
    </script>
</body>
</html>
